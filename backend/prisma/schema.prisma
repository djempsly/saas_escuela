generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Aquí definimos las diferencias de país y sistema) ---

enum Role {
  ADMIN                 // Superadmin de la plataforma
  DIRECTOR              // Director de la escuela
  COORDINADOR_ACADEMICO // ✅ Agregado: Coordinador
  COORDINADOR
  DOCENTE
  ESTUDIANTE
  SECRETARIA
}

enum Pais {
  DO // República Dominicana
  HT // Haití
}

// ✅ Aquí diferenciamos los tipos de evaluación
enum SistemaEducativo {
  // Dominicana
  INICIAL_DO          // Nivel Inicial (Preescolar)
  PRIMARIA_DO
  SECUNDARIA_GENERAL_DO
  POLITECNICO_DO // Lleva Calificación Técnica (RA)

  // Haití
  INICIAL_HT          // Nivel Inicial (Préscolaire)
  PRIMARIA_HT
  SECUNDARIA_HT
}

enum Idioma {
  ESPANOL
  FRANCES
  INGLES
  KREYOL
}

enum EstadoAsistencia {
  PRESENTE
  AUSENTE
  TARDE
  JUSTIFICADO
}

// ========== TASKS/ASSIGNMENTS ENUMS ==========
enum EstadoTarea {
  BORRADOR
  PUBLICADA
  CERRADA
}

enum EstadoEntrega {
  PENDIENTE
  ENTREGADO
  CALIFICADO
  ATRASADO
}

enum TipoRecurso {
  ENLACE
  VIDEO
  ARCHIVO
  IMAGEN
}

// ========== EVENTS ENUMS ==========
enum TipoEvento {
  ACADEMICO
  CULTURAL
  DEPORTIVO
  REUNION_PADRES
  FERIADO
  EVALUACION
  OTRO
}

// ========== PAYMENTS ENUMS ==========
enum ConceptoCobro {
  MATRICULA
  MENSUALIDAD
  MATERIAL
  UNIFORME
  ACTIVIDAD
  OTRO
}

enum EstadoPago {
  PENDIENTE
  PARCIAL
  PAGADO
  VENCIDO
}

enum MetodoPago {
  EFECTIVO
  TARJETA
  TRANSFERENCIA
  CHEQUE
}

enum TipoMateria {
  GENERAL // Materias normales (Matemáticas, Historia)
  TECNICA // Módulos técnicos (Solo para Politécnicos)
}

// --- MODELOS ---

model User {
  id                  String   @id @default(cuid())
  username            String   @unique
  email               String?  @unique
  password            String
  passwordTemporal    String?  // Contraseña temporal visible solo para ADMIN/DIRECTOR
  nombre              String
  apellido            String
  role                Role     @default(ESTUDIANTE)
  activo              Boolean  @default(true)
  debeCambiarPassword Boolean  @default(true)
  fotoUrl             String?
  telefono            String?
  direccion           String?

  // Relación con Institución (Multi-tenant)
  institucionId String?
  institucion   Institucion? @relation("UsuariosInstitucion", fields: [institucionId], references: [id])

  // Roles Jerárquicos
  directorDe              Institucion?              @relation("DirectorInstitucion")
  coordinadorDe           Nivel[]                   @relation("CoordinadorNivel")
  coordinadorCiclosEducativos CicloEducativo[]      @relation("CoordinadorCicloEducativo")

  // Relaciones Académicas
  clasesDictadas          Clase[]                   @relation("DocenteClase")
  inscripciones           Inscripcion[]
  calificaciones          Calificacion[]
  calificacionesTec       CalificacionTecnica[]
  asistencias             Asistencia[]
  actividades             Actividad[]
  notificaciones          Notificacion[]

  // Relaciones de nuevos módulos
  tareasCreadas           Tarea[]                   @relation("TareasCreadas")
  entregasTareas          EntregaTarea[]            @relation("EntregasTareas")
  eventosCreados          Evento[]                  @relation("EventosCreados")
  conversacionesCreadas   Conversacion[]            @relation("ConversacionesCreadas")
  mensajesEnviados        Mensaje[]                 @relation("MensajesEnviados")
  participaciones         ParticipanteConversacion[]
  cobros                  Cobro[]                   @relation("CobrosEstudiante")
  pagosRegistrados        Pago[]                    @relation("PagosRegistrados")

  // ✅ Super Admin - Historial de directores
  historialDirector       HistorialDirector[]       @relation("HistorialDirectores")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Institucion {
  id                String           @id @default(cuid())
  nombre            String
  lema              String?
  direccion         String?

  // ✅ Super Admin - URL y dominio personalizado
  slug                    String    @unique  // URL amigable interno (ej: "politecnico-olga")
  dominioPersonalizado    String?   @unique  // Dominio externo (ej: "politecnicoolgamodestamartinez.com")
  activo                  Boolean   @default(true)
  autogestionActividades  Boolean   @default(false)  // Permite al director subir actividades

  // ✅ Branding / Marca (Personalización desde Dashboard)
  logoUrl           String?
  logoPosicion      String           @default("center") // center, left, right - posición del logo en landing
  fondoLoginUrl     String?          // Imagen de fondo para la página de login
  colorPrimario     String           @default("#000000") // Para el header/botones
  colorSecundario   String           @default("#ffffff") // Para fondos/textos

  // ✅ Configuración Regional
  pais              Pais             @default(DO)
  sistema           SistemaEducativo
  idiomaPrincipal   Idioma           @default(ESPANOL)

  // Datos Ministeriales
  codigoCentro      String?
  distritoEducativo String?
  regionalEducacion String?

  directorId String @unique
  director   User   @relation("DirectorInstitucion", fields: [directorId], references: [id])

  usuarios User[]         @relation("UsuariosInstitucion")
  niveles  Nivel[]
  materias Materia[]
  ciclos   CicloLectivo[]
  ciclosEducativos CicloEducativo[]
  clases   Clase[]

  // Relaciones de nuevos módulos
  eventos             Evento[]
  conversaciones      Conversacion[]
  cobros              Cobro[]
  historialDirectores HistorialDirector[]
  actividades         Actividad[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ✅ Super Admin - Historial de directores por institución
model HistorialDirector {
  id              String      @id @default(cuid())
  institucionId   String
  institucion     Institucion @relation(fields: [institucionId], references: [id])
  directorId      String
  director        User        @relation("HistorialDirectores", fields: [directorId], references: [id])
  fechaInicio     DateTime    @default(now())
  fechaFin        DateTime?
  motivo          String?

  @@index([institucionId])
  @@index([directorId])
}

model Nivel {
  id            String      @id @default(cuid())
  nombre        String      // Ej: "1ro Secundaria", "6to Primaria"
  institucionId String
  institucion   Institucion @relation(fields: [institucionId], references: [id])

  coordinadorId String?
  coordinador   User?       @relation("CoordinadorNivel", fields: [coordinadorId], references: [id])

  cicloEducativoId String?
  cicloEducativo   CicloEducativo? @relation("NivelCicloEducativo", fields: [cicloEducativoId], references: [id])

  clases        Clase[]
}

model CicloLectivo {
  id            String      @id @default(cuid())
  nombre        String      // Ej: "2023-2024"
  fechaInicio   DateTime
  fechaFin      DateTime
  activo        Boolean     @default(true)
  institucionId String
  institucion   Institucion @relation(fields: [institucionId], references: [id])

  clases         Clase[]
  calificaciones Calificacion[]
  cobros         Cobro[]
  diasLaborables DiasLaborables[]
}

// CicloEducativo: Agrupa niveles en ciclos educativos (diferente de CicloLectivo que es año académico)
// Ej: "1er Ciclo" (1ro-3ro), "2do Ciclo" (4to-6to) para Primaria
model CicloEducativo {
  id              String       @id @default(cuid())
  nombre          String       // "1er Ciclo", "2do Ciclo"
  descripcion     String?
  orden           Int          @default(1)

  institucionId   String
  institucion     Institucion  @relation(fields: [institucionId], references: [id])

  niveles         Nivel[]      @relation("NivelCicloEducativo")
  coordinadores   User[]       @relation("CoordinadorCicloEducativo")

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([nombre, institucionId])
}

model Materia {
  id            String      @id @default(cuid())
  nombre        String
  descripcion   String?
  tipo          TipoMateria @default(GENERAL) // Si es TÉCNICA, usará CalificaciónTecnica
  institucionId String
  institucion   Institucion @relation(fields: [institucionId], references: [id])
  clases        Clase[]

  @@unique([nombre, institucionId])
}

model Clase {
  id             String       @id @default(cuid())
  codigo         String       @unique // Código único para inscribirse
  materiaId      String
  materia        Materia      @relation(fields: [materiaId], references: [id])
  nivelId        String
  nivel          Nivel        @relation(fields: [nivelId], references: [id])
  docenteId      String
  docente        User         @relation("DocenteClase", fields: [docenteId], references: [id])
  cicloLectivoId String
  cicloLectivo   CicloLectivo @relation(fields: [cicloLectivoId], references: [id])
  institucionId  String
  institucion    Institucion  @relation(fields: [institucionId], references: [id])

  inscripciones           Inscripcion[]
  asistencias             Asistencia[]
  calificaciones          Calificacion[]
  calificacionesTec       CalificacionTecnica[]

  // Relaciones de nuevos módulos
  tareas                  Tarea[]
  eventos                 Evento[]
  diasLaborables          DiasLaborables[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Inscripcion {
  id           String   @id @default(cuid())
  fecha        DateTime @default(now())
  estudianteId String
  estudiante   User     @relation(fields: [estudianteId], references: [id])
  claseId      String
  clase        Clase    @relation(fields: [claseId], references: [id])

  @@unique([estudianteId, claseId])
}

// ✅ CALIFICACIÓN GENERAL (Sirve para Primaria/Secundaria DO y HT)
// La lógica de cálculo se hará en el Backend dependiendo del Institucion.sistema
model Calificacion {
  id            String       @id @default(cuid())
  
  // Periodos (Haití usa 3 o 4 periodos, RD usa 4)
  p1            Float?       @default(0)
  p2            Float?       @default(0)
  p3            Float?       @default(0)
  p4            Float?       @default(0)
  
  // Recuperaciones
  rp1           Float?       @default(0)
  rp2           Float?       @default(0)
  rp3           Float?       @default(0)
  rp4           Float?       @default(0)
  
  // Campos específicos de la adecuación curricular RD (Pueden quedar null en HT)
  cpc_30        Float?       @default(0)
  cpc_total     Float?       @default(0)
  cpex_70       Float?       @default(0)
  cpex_total    Float?       @default(0)
  
  promedioFinal Float?       @default(0)
  situacion     String?      @default("PENDIENTE") // Aprobado, Reprobado, Aplazado
  
  estudianteId  String
  estudiante    User         @relation(fields: [estudianteId], references: [id])
  claseId       String
  clase         Clase        @relation(fields: [claseId], references: [id])
  cicloLectivoId String
  cicloLectivo  CicloLectivo @relation(fields: [cicloLectivoId], references: [id])

  updatedAt DateTime @updatedAt
  @@unique([estudianteId, claseId, cicloLectivoId])
}

// ✅ CALIFICACIÓN TÉCNICA (Solo para Politécnicos DO)
// Se basa en Resultados de Aprendizaje (RA)
model CalificacionTecnica {
  id           String @id @default(cuid())
  ra_codigo    String // Ej: "RA1.1"
  valor        Float  @default(0) // Nota del RA
  
  estudianteId String
  estudiante   User   @relation(fields: [estudianteId], references: [id])
  claseId      String
  clase        Clase  @relation(fields: [claseId], references: [id])

  @@unique([estudianteId, claseId, ra_codigo])
}

model Asistencia {
  id           String           @id @default(cuid())
  fecha        DateTime         @default(now())
  estado       EstadoAsistencia
  estudianteId String
  estudiante   User             @relation(fields: [estudianteId], references: [id])
  claseId      String
  clase        Clase            @relation(fields: [claseId], references: [id])
}

model Actividad {
  id              String       @id @default(cuid())
  titulo          String
  contenido       String       @db.Text
  urlArchivo      String?      // Imagen principal (legacy - compatibilidad)
  fotos           Json?        // Array de URLs de fotos ["url1", "url2", ...]
  videos          Json?        // Array de URLs de videos ["url1", "url2", ...]
  tipoMedia       String       @default("mixed") // foto, video, mixed
  autorId         String
  autor           User         @relation(fields: [autorId], references: [id])

  // ✅ Super Admin - Actividades por institución
  institucionId   String?       // NULL = actividad global (landing pública)
  institucion     Institucion?  @relation(fields: [institucionId], references: [id])
  publicado       Boolean       @default(true)

  createdAt       DateTime      @default(now())

  @@index([institucionId])
}

model Notificacion {
  id            String   @id @default(cuid())
  titulo        String
  mensaje       String
  leida         Boolean  @default(false)
  usuarioId     String
  usuario       User     @relation(fields: [usuarioId], references: [id])
  createdAt     DateTime @default(now())
}

// ========== TASKS/ASSIGNMENTS MODELS ==========

model Tarea {
  id              String       @id @default(cuid())
  titulo          String
  descripcion     String       @db.Text
  instrucciones   String?      @db.Text
  fechaPublicacion DateTime?
  fechaVencimiento DateTime
  puntajeMaximo   Float?
  estado          EstadoTarea  @default(BORRADOR)

  claseId         String
  clase           Clase        @relation(fields: [claseId], references: [id])
  docenteId       String
  docente         User         @relation("TareasCreadas", fields: [docenteId], references: [id])

  entregas        EntregaTarea[]
  recursos        RecursoTarea[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model EntregaTarea {
  id              String       @id @default(cuid())
  contenido       String?      @db.Text
  comentarioEstudiante String? @db.Text
  estado          EstadoEntrega @default(PENDIENTE)
  fechaEntrega    DateTime?
  calificacion    Float?
  comentarioDocente String?    @db.Text

  tareaId         String
  tarea           Tarea        @relation(fields: [tareaId], references: [id])
  estudianteId    String
  estudiante      User         @relation("EntregasTareas", fields: [estudianteId], references: [id])

  archivos        ArchivoEntrega[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([tareaId, estudianteId])
}

model RecursoTarea {
  id              String       @id @default(cuid())
  tipo            TipoRecurso
  titulo          String
  url             String

  tareaId         String
  tarea           Tarea        @relation(fields: [tareaId], references: [id])

  createdAt       DateTime     @default(now())
}

model ArchivoEntrega {
  id              String       @id @default(cuid())
  nombre          String
  url             String
  tipo            String       // mime type

  entregaId       String
  entrega         EntregaTarea @relation(fields: [entregaId], references: [id])

  createdAt       DateTime     @default(now())
}

// ========== EVENTS/CALENDAR MODELS ==========

model Evento {
  id              String       @id @default(cuid())
  titulo          String
  descripcion     String?      @db.Text
  ubicacion       String?
  tipo            TipoEvento
  fechaInicio     DateTime
  fechaFin        DateTime
  todoElDia       Boolean      @default(false)
  color           String?

  creadorId       String
  creador         User         @relation("EventosCreados", fields: [creadorId], references: [id])
  institucionId   String
  institucion     Institucion  @relation(fields: [institucionId], references: [id])
  claseId         String?
  clase           Clase?       @relation(fields: [claseId], references: [id])

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

// ========== MESSAGING MODELS ==========

model Conversacion {
  id              String       @id @default(cuid())
  titulo          String?
  esGrupal        Boolean      @default(false)

  creadorId       String
  creador         User         @relation("ConversacionesCreadas", fields: [creadorId], references: [id])
  institucionId   String
  institucion     Institucion  @relation(fields: [institucionId], references: [id])

  participantes   ParticipanteConversacion[]
  mensajes        Mensaje[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model ParticipanteConversacion {
  id              String       @id @default(cuid())

  conversacionId  String
  conversacion    Conversacion @relation(fields: [conversacionId], references: [id])
  usuarioId       String
  usuario         User         @relation(fields: [usuarioId], references: [id])

  ultimoLeido     DateTime?

  @@unique([conversacionId, usuarioId])
}

model Mensaje {
  id              String       @id @default(cuid())
  contenido       String       @db.Text

  conversacionId  String
  conversacion    Conversacion @relation(fields: [conversacionId], references: [id])
  remitenteId     String
  remitente       User         @relation("MensajesEnviados", fields: [remitenteId], references: [id])

  archivos        ArchivoMensaje[]

  createdAt       DateTime     @default(now())
}

model ArchivoMensaje {
  id              String       @id @default(cuid())
  nombre          String
  url             String
  tipo            String

  mensajeId       String
  mensaje         Mensaje      @relation(fields: [mensajeId], references: [id])
}

// ========== PAYMENTS MODELS ==========

model Cobro {
  id              String       @id @default(cuid())
  concepto        ConceptoCobro
  descripcion     String?
  monto           Decimal      @db.Decimal(10, 2)
  fechaVencimiento DateTime
  estado          EstadoPago   @default(PENDIENTE)

  estudianteId    String
  estudiante      User         @relation("CobrosEstudiante", fields: [estudianteId], references: [id])
  institucionId   String
  institucion     Institucion  @relation(fields: [institucionId], references: [id])
  cicloLectivoId  String
  cicloLectivo    CicloLectivo @relation(fields: [cicloLectivoId], references: [id])

  pagos           Pago[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Pago {
  id              String       @id @default(cuid())
  monto           Decimal      @db.Decimal(10, 2)
  metodoPago      MetodoPago
  referencia      String?
  fechaPago       DateTime     @default(now())
  comprobanteUrl  String?

  cobroId         String
  cobro           Cobro        @relation(fields: [cobroId], references: [id])
  registradoPorId String
  registradoPor   User         @relation("PagosRegistrados", fields: [registradoPorId], references: [id])

  createdAt       DateTime     @default(now())
}

// ========== ATTENDANCE TRACKING ==========

// Dias laborables por mes para calcular porcentaje de asistencia
model DiasLaborables {
  id              String       @id @default(cuid())

  // Meses del año escolar (1=Agosto, 2=Septiembre, ..., 11=Junio)
  agosto          Int          @default(0)
  septiembre      Int          @default(0)
  octubre         Int          @default(0)
  noviembre       Int          @default(0)
  diciembre       Int          @default(0)
  enero           Int          @default(0)
  febrero         Int          @default(0)
  marzo           Int          @default(0)
  abril           Int          @default(0)
  mayo            Int          @default(0)
  junio           Int          @default(0)

  claseId         String
  clase           Clase        @relation(fields: [claseId], references: [id], onDelete: Cascade)
  cicloLectivoId  String
  cicloLectivo    CicloLectivo @relation(fields: [cicloLectivoId], references: [id])

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([claseId, cicloLectivoId])
}
generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String                     @id @default(cuid())
  username                    String                     @unique
  email                       String?                    @unique
  password                    String
  nombre                      String                     // Primer nombre
  segundoNombre               String?                    // Segundo nombre (opcional)
  apellido                    String                     // Primer apellido
  segundoApellido             String?                    // Segundo apellido (opcional)
  role                        Role                       @default(ESTUDIANTE)
  activo                      Boolean                    @default(true)
  debeCambiarPassword         Boolean                    @default(true)
  fotoUrl                     String?
  telefono                    String?
  direccion                   String?
  institucionId               String?
  createdAt                   DateTime                   @default(now())
  updatedAt                   DateTime                   @updatedAt
  actividades                 Actividad[]
  asistencias                 Asistencia[]
  calificaciones              Calificacion[]
  calificacionesCompetencia   CalificacionCompetencia[]  @relation("CalificacionesCompetencia")
  calificacionesTec           CalificacionTecnica[]
  clasesDictadas              Clase[]                    @relation("DocenteClase")
  cobros                      Cobro[]                    @relation("CobrosEstudiante")
  conversacionesCreadas       Conversacion[]             @relation("ConversacionesCreadas")
  entregasTareas              EntregaTarea[]             @relation("EntregasTareas")
  eventosCreados              Evento[]                   @relation("EventosCreados")
  historialDirector           HistorialDirector[]        @relation("HistorialDirectores")
  inscripciones               Inscripcion[]
  directorDe                  Institucion?               @relation("DirectorInstitucion")
  mensajesEnviados            Mensaje[]                  @relation("MensajesEnviados")
  coordinadorDe               Nivel[]                    @relation("CoordinadorNivel")
  nivelActualId               String?
  nivelActual                 Nivel?                     @relation("EstudianteNivelActual", fields: [nivelActualId], references: [id])
  notificaciones              Notificacion[]
  pagosRegistrados            Pago[]                     @relation("PagosRegistrados")
  participaciones             ParticipanteConversacion[]
  tareasCreadas               Tarea[]                    @relation("TareasCreadas")
  auditLogs                   AuditLog[]                 @relation("AuditLogs")
  refreshTokens               RefreshToken[]
  institucion                 Institucion?               @relation("UsuariosInstitucion", fields: [institucionId], references: [id])
  coordinadorCiclosEducativos CicloEducativo[]           @relation("CoordinadorCicloEducativo")
}

model Institucion {
  id                     String                        @id @default(cuid())
  nombre                 String
  lema                   String?
  direccion              String?
  logoUrl                String?
  colorPrimario          String                        @default("#1a56db")
  colorSecundario        String                        @default("#7c3aed")
  pais                   Pais                          @default(DO)
  sistema                SistemaEducativo
  idiomaPrincipal        Idioma                        @default(ESPANOL)
  codigoCentro           String?
  distritoEducativo      String?
  regionalEducacion      String?
  directorId             String                        @unique
  activo                 Boolean                       @default(true)
  autogestionActividades Boolean                       @default(false)
  dominioPersonalizado   String?                       @unique
  slug                   String                        @unique
  logoPosicion           String                        @default("center")
  fondoLoginUrl          String?
  createdAt              DateTime                      @default(now())
  updatedAt              DateTime                      @updatedAt
  municipio              String?
  provincia              String?
  sector                 String?
  accentColor            String                        @default("#059669")
  faviconUrl             String?
  heroImageUrl           String?
  heroSubtitle           String?
  heroTitle              String?
  loginBgColor           String                        @default("#f3f4f6")
  loginBgGradient        String?
  loginBgType            String                        @default("color")
  loginLogoUrl           String?
  logoHeight             Int?                          @default(60)
  logoWidth              Int?                          @default(120)
  nombreMostrar          String?
  sabanaColores          Json?
  actividades            Actividad[]
  ciclosEducativos       CicloEducativo[]
  ciclos                 CicloLectivo[]
  clases                 Clase[]
  cobros                 Cobro[]
  conversaciones         Conversacion[]
  eventos                Evento[]
  historialDirectores    HistorialDirector[]
  director               User                          @relation("DirectorInstitucion", fields: [directorId], references: [id])
  dominios               InstitucionDominio[]
  sistemasEducativos     InstitucionSistemaEducativo[]
  materias               Materia[]
  niveles                Nivel[]
  auditLogs              AuditLog[]                    @relation("AuditLogsInstitucion")
  usuarios               User[]                        @relation("UsuariosInstitucion")
}

model InstitucionDominio {
  id            String      @id @default(cuid())
  institucionId String
  dominio       String      @unique
  verificado    Boolean     @default(false)
  sslActivo     Boolean     @default(false)
  verificadoAt  DateTime?
  ultimoCheck   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  institucion   Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)

  @@index([dominio])
  @@index([institucionId])
}

model HistorialDirector {
  id            String      @id @default(cuid())
  institucionId String
  directorId    String
  fechaInicio   DateTime    @default(now())
  fechaFin      DateTime?
  motivo        String?
  director      User        @relation("HistorialDirectores", fields: [directorId], references: [id])
  institucion   Institucion @relation(fields: [institucionId], references: [id])

  @@index([institucionId])
  @@index([directorId])
}

model InstitucionSistemaEducativo {
  id            String           @id @default(cuid())
  institucionId String
  sistema       SistemaEducativo
  activo        Boolean          @default(true)
  createdAt     DateTime         @default(now())
  institucion   Institucion      @relation(fields: [institucionId], references: [id], onDelete: Cascade)

  @@unique([institucionId, sistema])
  @@index([institucionId])
}

model Nivel {
  id               String          @id @default(cuid())
  nombre           String
  institucionId    String
  coordinadorId    String?
  cicloEducativoId String?
  gradoNumero      Int?
  formatoSabana    FormatoSabana   @default(SECUNDARIA_DO)
  numeroPeriodos   Int             @default(4)
  usaCompetencias  Boolean         @default(true)
  usaModulosTec    Boolean         @default(false)
  clases           Clase[]
  estudiantesActuales User[]       @relation("EstudianteNivelActual")
  cicloEducativo   CicloEducativo? @relation("NivelCicloEducativo", fields: [cicloEducativoId], references: [id])
  coordinador      User?           @relation("CoordinadorNivel", fields: [coordinadorId], references: [id])
  institucion      Institucion     @relation(fields: [institucionId], references: [id])
}

model CicloLectivo {
  id                        String                    @id @default(cuid())
  nombre                    String
  fechaInicio               DateTime
  fechaFin                  DateTime
  activo                    Boolean                   @default(true)
  cerrado                   Boolean                   @default(false)
  cerradoAt                 DateTime?
  institucionId             String
  calificaciones            Calificacion[]
  calificacionesCompetencia CalificacionCompetencia[] @relation("CicloCalificacionesCompetencia")
  institucion               Institucion               @relation(fields: [institucionId], references: [id])
  clases                    Clase[]
  cobros                    Cobro[]
  diasLaborables            DiasLaborables[]
}

model CicloEducativo {
  id            String              @id @default(cuid())
  nombre        String
  descripcion   String?
  tipo          TipoCicloEducativo?
  orden         Int                 @default(1)
  institucionId String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  institucion   Institucion         @relation(fields: [institucionId], references: [id])
  niveles       Nivel[]             @relation("NivelCicloEducativo")
  coordinadores User[]              @relation("CoordinadorCicloEducativo")

  @@unique([nombre, institucionId])
}

model Materia {
  id            String      @id @default(cuid())
  nombre        String
  descripcion   String?
  tipo          TipoMateria @default(GENERAL)
  institucionId String
  codigo        String?
  esOficial     Boolean     @default(false)
  orden         Int         @default(0)
  pais          String?
  provisional   Boolean     @default(false)
  clases        Clase[]
  institucion   Institucion @relation(fields: [institucionId], references: [id])

  @@unique([nombre, institucionId])
  @@index([institucionId, esOficial])
}

model Clase {
  id                        String                    @id @default(cuid())
  codigo                    String
  materiaId                 String
  nivelId                   String
  docenteId                 String
  cicloLectivoId            String
  institucionId             String
  createdAt                 DateTime                  @default(now())
  updatedAt                 DateTime                  @updatedAt
  seccion                   String?
  tanda                     Tanda                     @default(MATUTINA)
  asistencias               Asistencia[]
  calificaciones            Calificacion[]
  calificacionesCompetencia CalificacionCompetencia[] @relation("ClaseCalificacionesCompetencia")
  calificacionesTec         CalificacionTecnica[]
  cicloLectivo              CicloLectivo              @relation(fields: [cicloLectivoId], references: [id])
  docente                   User                      @relation("DocenteClase", fields: [docenteId], references: [id])
  institucion               Institucion               @relation(fields: [institucionId], references: [id])
  materia                   Materia                   @relation(fields: [materiaId], references: [id])
  nivel                     Nivel                     @relation(fields: [nivelId], references: [id])
  diasLaborables            DiasLaborables[]
  eventos                   Evento[]
  inscripciones             Inscripcion[]
  tareas                    Tarea[]

  @@unique([codigo, nivelId, seccion, institucionId])
  @@index([nivelId, cicloLectivoId])
}

model Inscripcion {
  id           String   @id @default(cuid())
  fecha        DateTime @default(now())
  estudianteId String
  claseId      String
  activa       Boolean  @default(true)
  clase        Clase    @relation(fields: [claseId], references: [id])
  estudiante   User     @relation(fields: [estudianteId], references: [id])

  @@unique([estudianteId, claseId])
  @@index([claseId])
  @@index([estudianteId])
}

model Calificacion {
  id             String       @id @default(cuid())
  p1             Float?       @default(0)
  p2             Float?       @default(0)
  p3             Float?       @default(0)
  p4             Float?       @default(0)
  rp1            Float?       @default(0)
  rp2            Float?       @default(0)
  rp3            Float?       @default(0)
  rp4            Float?       @default(0)
  cpc_30         Float?       @default(0)
  cpc_total      Float?       @default(0)
  cpc_nota       Float?       @default(0)
  cpex_70        Float?       @default(0)
  cpex_nota      Float?       @default(0)
  cpex_total     Float?       @default(0)
  promedioFinal  Float?       @default(0)
  situacion      String?      @default("PENDIENTE")
  estudianteId   String
  claseId        String
  cicloLectivoId String
  updatedAt      DateTime     @updatedAt
  publicado       Boolean      @default(false)
  publicadoAt     DateTime?
  publicadoPor    String?
  observaciones   String?
  cicloLectivo   CicloLectivo @relation(fields: [cicloLectivoId], references: [id])
  clase          Clase        @relation(fields: [claseId], references: [id])
  estudiante     User         @relation(fields: [estudianteId], references: [id])

  @@unique([estudianteId, claseId, cicloLectivoId])
  @@index([estudianteId, cicloLectivoId])
  @@index([claseId, cicloLectivoId])
}

model CalificacionCompetencia {
  id             String       @id @default(cuid())
  competencia    String
  p1             Float?       @default(0)
  p2             Float?       @default(0)
  p3             Float?       @default(0)
  p4             Float?       @default(0)
  rp1            Float?       @default(0)
  rp2            Float?       @default(0)
  rp3            Float?       @default(0)
  rp4            Float?       @default(0)
  estudianteId   String
  claseId        String
  cicloLectivoId String
  updatedAt      DateTime     @updatedAt
  publicado       Boolean      @default(false)
  publicadoAt     DateTime?
  publicadoPor    String?
  cicloLectivo   CicloLectivo @relation("CicloCalificacionesCompetencia", fields: [cicloLectivoId], references: [id])
  clase          Clase        @relation("ClaseCalificacionesCompetencia", fields: [claseId], references: [id])
  estudiante     User         @relation("CalificacionesCompetencia", fields: [estudianteId], references: [id])

  @@unique([estudianteId, claseId, cicloLectivoId, competencia])
  @@index([claseId, cicloLectivoId])
  @@index([estudianteId, cicloLectivoId])
}

model CalificacionTecnica {
  id           String @id @default(cuid())
  ra_codigo    String
  valor        Float  @default(0)
  estudianteId String
  claseId      String
  clase        Clase  @relation(fields: [claseId], references: [id])
  estudiante   User   @relation(fields: [estudianteId], references: [id])

  @@unique([estudianteId, claseId, ra_codigo])
  @@index([claseId])
  @@index([estudianteId])
}

model Asistencia {
  id           String           @id @default(cuid())
  fecha        DateTime         @default(now())
  estado       EstadoAsistencia
  estudianteId String
  claseId      String
  clase        Clase            @relation(fields: [claseId], references: [id])
  estudiante   User             @relation(fields: [estudianteId], references: [id])
}

model Actividad {
  id            String       @id @default(cuid())
  titulo        String
  contenido     String
  urlArchivo    String?
  autorId       String
  createdAt     DateTime     @default(now())
  institucionId String?
  publicado     Boolean      @default(true)
  fotos         Json?
  tipoMedia     String       @default("mixed")
  videos        Json?
  autor         User         @relation(fields: [autorId], references: [id])
  institucion   Institucion? @relation(fields: [institucionId], references: [id])

  @@index([institucionId])
}

model Notificacion {
  id        String   @id @default(cuid())
  titulo    String
  mensaje   String
  leida     Boolean  @default(false)
  usuarioId String
  createdAt DateTime @default(now())
  usuario   User     @relation(fields: [usuarioId], references: [id])
}

model Tarea {
  id               String         @id @default(cuid())
  titulo           String
  descripcion      String
  instrucciones    String?
  fechaPublicacion DateTime?
  fechaVencimiento DateTime
  puntajeMaximo    Float?
  estado           EstadoTarea    @default(BORRADOR)
  claseId          String
  docenteId        String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  entregas         EntregaTarea[]
  recursos         RecursoTarea[]
  clase            Clase          @relation(fields: [claseId], references: [id])
  docente          User           @relation("TareasCreadas", fields: [docenteId], references: [id])
}

model EntregaTarea {
  id                   String           @id @default(cuid())
  contenido            String?
  comentarioEstudiante String?
  estado               EstadoEntrega    @default(PENDIENTE)
  fechaEntrega         DateTime?
  calificacion         Float?
  comentarioDocente    String?
  tareaId              String
  estudianteId         String
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  archivos             ArchivoEntrega[]
  estudiante           User             @relation("EntregasTareas", fields: [estudianteId], references: [id])
  tarea                Tarea            @relation(fields: [tareaId], references: [id])

  @@unique([tareaId, estudianteId])
}

model RecursoTarea {
  id        String      @id @default(cuid())
  tipo      TipoRecurso
  titulo    String
  url       String
  tareaId   String
  createdAt DateTime    @default(now())
  tarea     Tarea       @relation(fields: [tareaId], references: [id])
}

model ArchivoEntrega {
  id        String       @id @default(cuid())
  nombre    String
  url       String
  tipo      String
  entregaId String
  createdAt DateTime     @default(now())
  entrega   EntregaTarea @relation(fields: [entregaId], references: [id])
}

model Evento {
  id            String      @id @default(cuid())
  titulo        String
  descripcion   String?
  ubicacion     String?
  tipo          TipoEvento
  fechaInicio   DateTime
  fechaFin      DateTime
  todoElDia     Boolean     @default(false)
  color         String?
  creadorId     String
  institucionId String
  claseId       String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  clase         Clase?      @relation(fields: [claseId], references: [id])
  creador       User        @relation("EventosCreados", fields: [creadorId], references: [id])
  institucion   Institucion @relation(fields: [institucionId], references: [id])
}

model Conversacion {
  id            String                     @id @default(cuid())
  titulo        String?
  esGrupal      Boolean                    @default(false)
  creadorId     String
  institucionId String
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  creador       User                       @relation("ConversacionesCreadas", fields: [creadorId], references: [id])
  institucion   Institucion                @relation(fields: [institucionId], references: [id])
  mensajes      Mensaje[]
  participantes ParticipanteConversacion[]
}

model ParticipanteConversacion {
  id             String       @id @default(cuid())
  conversacionId String
  usuarioId      String
  ultimoLeido    DateTime?
  conversacion   Conversacion @relation(fields: [conversacionId], references: [id])
  usuario        User         @relation(fields: [usuarioId], references: [id])

  @@unique([conversacionId, usuarioId])
}

model Mensaje {
  id             String           @id @default(cuid())
  contenido      String
  conversacionId String
  remitenteId    String
  createdAt      DateTime         @default(now())
  archivos       ArchivoMensaje[]
  conversacion   Conversacion     @relation(fields: [conversacionId], references: [id])
  remitente      User             @relation("MensajesEnviados", fields: [remitenteId], references: [id])
}

model ArchivoMensaje {
  id        String  @id @default(cuid())
  nombre    String
  url       String
  tipo      String
  mensajeId String
  mensaje   Mensaje @relation(fields: [mensajeId], references: [id])
}

model Cobro {
  id               String        @id @default(cuid())
  concepto         ConceptoCobro
  descripcion      String?
  monto            Decimal       @db.Decimal(10, 2)
  fechaVencimiento DateTime
  estado           EstadoPago    @default(PENDIENTE)
  estudianteId     String
  institucionId    String
  cicloLectivoId   String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  cicloLectivo     CicloLectivo  @relation(fields: [cicloLectivoId], references: [id])
  estudiante       User          @relation("CobrosEstudiante", fields: [estudianteId], references: [id])
  institucion      Institucion   @relation(fields: [institucionId], references: [id])
  pagos            Pago[]
}

model Pago {
  id              String     @id @default(cuid())
  monto           Decimal    @db.Decimal(10, 2)
  metodoPago      MetodoPago
  referencia      String?
  fechaPago       DateTime   @default(now())
  comprobanteUrl  String?
  cobroId         String
  registradoPorId String
  createdAt       DateTime   @default(now())
  cobro           Cobro      @relation(fields: [cobroId], references: [id])
  registradoPor   User       @relation("PagosRegistrados", fields: [registradoPorId], references: [id])
}

model DiasLaborables {
  id             String       @id @default(cuid())
  agosto         Int          @default(0)
  septiembre     Int          @default(0)
  octubre        Int          @default(0)
  noviembre      Int          @default(0)
  diciembre      Int          @default(0)
  enero          Int          @default(0)
  febrero        Int          @default(0)
  marzo          Int          @default(0)
  abril          Int          @default(0)
  mayo           Int          @default(0)
  junio          Int          @default(0)
  claseId        String
  cicloLectivoId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  cicloLectivo   CicloLectivo @relation(fields: [cicloLectivoId], references: [id])
  clase          Clase        @relation(fields: [claseId], references: [id], onDelete: Cascade)

  @@unique([claseId, cicloLectivoId])
}

model AuditLog {
  id            String       @id @default(cuid())
  accion        AccionAudit
  entidad       String
  entidadId     String?
  descripcion   String
  datos         Json?
  oldValue      Json?
  newValue      Json?
  ipAddress     String?
  userAgent     String?
  usuarioId     String
  institucionId String?
  createdAt     DateTime     @default(now())
  usuario       User         @relation("AuditLogs", fields: [usuarioId], references: [id])
  institucion   Institucion? @relation("AuditLogsInstitucion", fields: [institucionId], references: [id])

  @@index([institucionId, createdAt])
  @@index([usuarioId])
  @@index([entidadId])
}

model SystemSettings {
  id                      String   @id @default("system")
  maintenanceMode         Boolean  @default(false)
  allowPublicRegistration Boolean  @default(false)
  maxInstitutionsPerPlan  Int      @default(10)
  defaultSessionTimeout   Int      @default(24)
  updatedAt               DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum Role {
  ADMIN
  DIRECTOR
  COORDINADOR_ACADEMICO
  COORDINADOR
  DOCENTE
  ESTUDIANTE
  SECRETARIA
}

enum Pais {
  DO
  HT
}

enum SistemaEducativo {
  PRIMARIA_DO
  SECUNDARIA_GENERAL_DO
  POLITECNICO_DO
  PRIMARIA_HT
  SECUNDARIA_HT
  INICIAL_DO
  INICIAL_HT
}

enum Idioma {
  ESPANOL
  FRANCES
  INGLES
  KREYOL
}

enum Tanda {
  MATUTINA
  VESPERTINA
  NOCTURNA
  SABATINA
  EXTENDIDA
}

enum EstadoAsistencia {
  PRESENTE
  AUSENTE
  TARDE
  JUSTIFICADO
}

enum EstadoTarea {
  BORRADOR
  PUBLICADA
  CERRADA
}

enum EstadoEntrega {
  PENDIENTE
  ENTREGADO
  CALIFICADO
  ATRASADO
}

enum TipoRecurso {
  ENLACE
  VIDEO
  ARCHIVO
  IMAGEN
}

enum TipoEvento {
  ACADEMICO
  CULTURAL
  DEPORTIVO
  REUNION_PADRES
  FERIADO
  EVALUACION
  OTRO
}

enum ConceptoCobro {
  MATRICULA
  MENSUALIDAD
  MATERIAL
  UNIFORME
  ACTIVIDAD
  OTRO
}

enum EstadoPago {
  PENDIENTE
  PARCIAL
  PAGADO
  VENCIDO
}

enum MetodoPago {
  EFECTIVO
  TARJETA
  TRANSFERENCIA
  CHEQUE
}

enum TipoMateria {
  GENERAL
  TECNICA
}

enum AccionAudit {
  CREAR
  ACTUALIZAR
  ELIMINAR
  IMPORTAR
  LOGIN
  LOGOUT
  PASSWORD_CAMBIADO
  CALIFICACION_PUBLICADA
  CONFIG_MODIFICADA
  DESINSCRIPCION
}

enum FormatoSabana {
  INICIAL_DO
  INICIAL_HT
  PRIMARIA_DO
  PRIMARIA_HT
  SECUNDARIA_DO
  SECUNDARIA_HT
  POLITECNICO_DO
  ADULTOS
}

enum TipoCicloEducativo {
  INICIAL
  PRIMARIA
  SECUNDARIA
  POLITECNICO
  ADULTOS
}
